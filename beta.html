<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Audio Demo</title>
    <link rel="stylesheet" href="upload/bootstrap.css">
    <link rel="stylesheet" href="user-infinity.css">
    <style>
#myCanvas
{
    pointer-events: none;       /* make the canvas transparent to the mouse - needed since canvas is position infront of image */
    position:absolute;
    z-index: 2;
}


    </style>
    <script>
        function dummy(){console.log("dummy");}
    </script>
    <script type="text/javascript" src="howler/howler.js/dist/howler.js"></script>
       <script type="text/javascript" src="user-infinity.js"></script>
    <script>


/* Todo
        Make sure the correct portion of the image is visible
        Figure out how it's been scaled
        Draw a red dot where it's playing
        Set a range to display the density
*/

        var queue = [];
        var playing = false;
        var preloaded = false;
        var panels = [];
        var played = [];
        var density;
        var panels_json;
        var images = {};
        

        function nextSlidePlease(oldurl, newurl, img){
            var oldImg = images[oldurl];
            if(valid(oldImg)){
                oldImg.clearPoints();
            }
            
            var newImg = images[newurl];
            if(!valid(newImg)){
                
                newImg = new ImgHandler();
               
                images[newurl] = newImg;
            }
            newImg.setImg(img);
            newImg.setUrl(newurl);
            var canvas = document.getElementById("myCanvas");
            newImg.setCanvas(canvas);
        }

        function mark_played(clip){
            if(!is_played(clip)){
                played.push(clip.arr);
                if (played.length > 200){
                    var old = played.shift();
                    old.unload(); // just make sure to prevent memory leaks
                }
            }
        }

        function is_played(clip){
            return (played.includes(clip.arr));
        }

        function player () {
            if (playing) {
                var waittime;
                var active = queue.shift();
                var ready = false;

                // First see if we need to load more audio
                if (queue.length <= 2){
                    if (panels.length < 3){
                        started = true; // just so we're clear
                        play_stuff(); // add more panels to the queu
                    }
                    var nextpanel = panels.shift();
                    if (valid(nextpanel)){
                        loadaudio(nextpanel);
                    } else {
                        // start over
                        play_stuff();
                    }
                }

                // check if the queue was empty and if any file removed from it was ready
                if (valid(active)){

                    if (valid(active.howl)){
                       
                        
                        if (active.loaded()){
                            var denseness = density.value();
                            var dur = active.dur;  // was dur()
                            var panspread = linlin(denseness, 3.0, 5.0, 0.5, 0.78);
                            //console.log("pan " + panspread);
                            active.pan(rrand((-1.0 * panspread), panspread));
                            active.amp((1/denseness) * rrand(0.8, 1.2));
                            if(rrand(3,10)< 1){
                                active.setRate(rrand(0.9, 1.1));
                            } else {
                                active.setRate(1);
                            }
                            active.howl.play();

                            var img =  document.getElementById("score");
                            if(valid(img)){
                            //    //div.innerHTML = "Panel " + active.page_no;
                                var imgurl = "score_pages/" + active.imgurl;
                                if (img.src != imgurl){
                                    nextSlidePlease(img.src, imgurl, img);
                                    //images[img.src].clearPoints
                            //        img.src = imgurl;
                                }
                            }
                            var handler = images[imgurl];
                            handler.drawPoint(active.x, active.y);


                            ready = true;
                            mark_played(active);

                            console.log("Density "+ denseness);
                            waittime = Math.min(dur * (1.5 / denseness), 15);  //rrand(dur/5, dur*1.1);
                            active.setRepeats(Math.floor(rrand(((-2 * denseness)-1),denseness)));
                            
                            if ((dur < 5) && (rrand(0, 13) < 5)){
                                //active = queue.shift();
                                queue.unshift(active);
                            } else {
                                //active.clip.on("end", function(){
                                    //toPlay.unload();
                                //    active.clip.unload();
                                //})
                                active.setFinished(function(){ 
                                    
                                    active.unload();
                                });
                            }


                        } else { // not ready
                            queue.unshift(active);
                        }
                        this} else {
                        //active.load();
                        queue.unshift(active);
                    }
                } else { // out of items
                    console.log("queue empty");
                }
                if (! ready){
                    waittime = rrand(2, 10);
                }
                setTimeout(player, waittime*1000);
            } // if playing
        }
        
        function loadaudio(panel) {
            var id; var num; var img;
            id = panel[1];
            num = panel[0];
            img = panel[2];
            console.log("doplay " + img);
            
            loadJSON('json/' + id + '.json',
                function(audio_files) { //console.log(audio_files); 
                    
                    var chosen = getNRandSortedExcluding(audio_files, linlin(density.middle, 1,5, 7, 15), played);
                    //var sounds = [];
                    //var howl;
                    //var queue = [];
                    var clip;
                    
                    chosen.forEach(element => {
                        if (valid(element)){
                            /*
                            howl = new Howl ({ 
                                src: "processed_audio/" + [element[2] + "/" + element[4]], 
                                preload: true,
                                volume: 0.5,
                                loop: false /*,
                                onload:  function () {
                                  queue.push(howl);
                                    if (! started){
                                        started = true;
                                        //var active = queue.shift();
                                        setTimeout(player, rrand(200, 3000));
                                  }
                                }
                            });
                            */
                            //queue.push(howl);
                            clip = new AudioClip(element, num, img);
                            clip.setRepeats(Math.floor(rrand(((-2 * density.middle)-1),density.middle)));
                            if (!is_played(clip)){
                                queue.push(clip);
                            };
                        }
                    });
                    
                }, 
                function(xhr) { console.error(xhr); }
            );
            
        }
        
        function play_stuff(){           

            loadJSON('json/panels.json',
                function(panel_info){
                    panels_json = panel_info;
                    Object.keys(panel_info).sort().forEach(key => {
                    //panel_info.forEach(panel => {
                        var panel = panel_info[key];
                        console.log(panel);
                        //panel.unshift(key);
                        panels.push(panel);
                        if(! preloaded){
                            preloaded = true;
                            density = new Ramp();
                            loadaudio(panels.shift());
                        }
                        //if (!started){
                        //    started = true;
                        //    density = new Ramp();
                        //    loadaudio(panels.shift());
                        //    setTimeout(player, rrand(1000, 3000));
                        //}
                        var imgurl = panel[2];
                        if(!valid(images[imgurl])){
                            images[imgurl] = new ImgHandler();
                        }
                    })
                }
            )
        }

        function start(){
            if(! playing){
                playing = true;
                
                loadaudio(panels.shift());
                setTimeout(player, 500);
            }

        }

        function stop() {
            playing = false;
            Howler.stop();
        }

        function init() {
            // resize the canvas to fit the image
            var img =  document.getElementById("score");
            var canvas = document.getElementById("myCanvas");
            canvas.height = img.clientHeight;
 
            play_stuff();
        }
        
    </script>
</head>
<body  onload="init();">
    <div class="page-header">
        <h1>Audio Demo</h1>
    </div>
    <nav class="navbar navbar-default" id="myTopnav">
        <div class="container-fluid">
            <ul class="nav navbar-nav">
                <li><a href="./">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="credits.html">Credits</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
            
                <li><a href="./upload">Contributor Login</a></li>
            </ul>
        </div>
    </nav>
    <div><form><input type="button" VALUE="Play" onClick="start();"><input type="button" VALUE="Stop" onClick="stop();"></form></div>
    <div class="flex-container">
        <div class="playing-img">
            <div class="overflow full-width" id="con" width="1400"  height="200">
                <canvas id="myCanvas" class="overflow" width="1400" height="200" min-width="300"></canvas>
                <img class="anchor-img playing-img" src="score_pages/metaphysics_1.jpg" alt="The Score" id="score"  width="1400" height="200" class="overflow" min-width="300">
          <!--   <p><img class="playing-img" src = "score_pages/metaphysics_1.jpg" id = "score"   width="300" height = "200" /></p>-->
        </div>
    </div>
</body>
</html>