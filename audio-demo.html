<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Audio Demo</title>
    <link rel="stylesheet" href="upload/bootstrap.css">
    <link rel="stylesheet" href="user-infinity.css">
    <style>
#myCanvas
{
    pointer-events: none;       /* make the canvas transparent to the mouse - needed since canvas is position infront of image */
    position:absolute;
    z-index: 2;
}


    </style>
    <script>
        function dummy(){console.log("dummy");}
    </script>
    <script type="text/javascript" src="howler/howler.js/dist/howler.js"></script>
    <script type="text/javascript" src="user-infinity.js"></script>
    <script>

        var queue = [];
        var started = false;
        var panels = [];

        function player () {
            var waittime;
            var active = queue.shift();
            var ready = false;

            // First see if we need to load more audio
            if (queue.length <= 2){
                var nextpanel = panels.shift();
                if (valid(nextpanel)){
                    loadaudio(nextpanel);
                } else {
                    // start over
                    play_stuff();
                }
            }

            // check if the queue was empty and if any file removed from it was ready
            if (valid(active)){
                if(active.state() == "loaded"){
                    let toPlay = { ...active };
                    // set the file to play
                    var dur = toPlay.duration();
                    toPlay.stereo(rrand(-0.5, 0.5));
                    toPlay.volume(rrand(0.2, 0.7));
                    if(rrand(0,10)< 1){
                        toPlay.rate(rrand(0.9, 1.1));
                    } else {
                        toPlay.rate(1);
                    }
                    toPlay.play();
                    ready = true;
                    waittime = rrand(dur/5, dur*1.1);
                    if ((dur < 5) && (rrand(0, 13) < 5)){
                        //active = queue.shift();
                        queue.unshift(active);
                    } else {
                        toPlay.on("end", function(){
                            toPlay.unload();
                            active.unload();
                        })
                    }
                } else { // not ready
                    queue.unshift(active);
                } 
            } else { // out of items
                console.log("queue empty");
            }
            if (! ready){
                waittime = rrand(2, 10);
            }
            setTimeout(player, waittime*1000);
        }
        
        function loadaudio(panel) {
            console.log("doplay");
            
            loadJSON('json/' + panel + '.json',
                function(audio_files) { //console.log(audio_files); 
                    
                    var chosen = getNRandSorted(audio_files, 5);
                    //var sounds = [];
                    var howl;
                    //var queue = [];
                    
                    chosen.forEach(element => {
                        if (valid(element)){
                            howl = new Howl ({ 
                                src: "processed_audio/" + [element[2] + "/" + element[4]], 
                                preload: true,
                                volume: 0.5,
                                loop: false /*,
                                onload:  function () {
                                  queue.push(howl);
                                    if (! started){
                                        started = true;
                                        //var active = queue.shift();
                                        setTimeout(player, rrand(200, 3000));
                                  }
                                }*/
                            });
                            queue.push(howl);
                        }
                    });
                    
                }, 
                function(xhr) { console.error(xhr); }
            );
            
        }
        
        function play_stuff(){
            //var started = false;
            loadJSON('json/panels.json',
                function(panel_info){
                    panel_info.forEach(panel => {
                        panels.push(panel[1]);
                        if (!started){
                            started = true;
                            loadaudio(panels.shift());
                            setTimeout(player, rrand(200, 3000));
                        }
                    })
                }
            )
        }

        
    </script>
</head>
<body  onload="play_stuff();">
    <div class="page-header">
        <h1>Audio Demo</h1>
    </div>
</body>
</html>